name: 'Run UI Tests'
description: 'Execute UI tests with video recording and logging'
inputs:
  test-file:
    description: 'Test file to run'
    required: false
    default: 'tests/ui/registration/test_registration_stability.py'
  pytest-args:
    description: 'Additional pytest arguments'
    required: false
    default: '-v --tb=short'
  scenario:
    description: 'Test scenario to run'
    required: false
    default: 'all'
  video-retention-days:
    description: 'Days to retain video artifacts'
    required: false
    default: '7'

outputs:
  test-result:
    description: 'Test execution result (success/failure)'
    value: ${{ steps.run-tests.outputs.result }}
  test-summary:
    description: 'Test execution summary'
    value: ${{ steps.run-tests.outputs.summary }}

runs:
  using: 'composite'
  steps:
    - name: Create test results directory
      shell: bash
      run: |
        mkdir -p test-results/videos
        mkdir -p test-results/screenshots
        mkdir -p test-results/logs

    - name: Configure Playwright for CI
      shell: bash
      run: |
        export PLAYWRIGHT_BROWSERS_PATH=$HOME/.cache/ms-playwright
        echo "PLAYWRIGHT_BROWSERS_PATH=$HOME/.cache/ms-playwright" >> $GITHUB_ENV
        echo "PWDEBUG=0" >> $GITHUB_ENV
        echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
        echo "PYTHONWARNINGS=ignore" >> $GITHUB_ENV

    - name: Run UI Tests
      id: run-tests
      shell: bash
      run: |
        set +e
        
        echo "ðŸ§ª Running UI tests..."
        echo "ðŸ“ Test file: ${{ inputs.test-file }}"
        echo "ðŸ”§ Pytest args: ${{ inputs.pytest-args }}"
        echo "ï¿½ Scenario: ${{ inputs.scenario }}"
        echo "ï¿½ðŸŒ Environment: $ENVIRONMENT"
        echo "ðŸ“± Device: $DEVICE"
        echo "ðŸ Python path: $PYTHONPATH"
        
        # Build pytest command based on scenario
        if [ "${{ inputs.scenario }}" = "all" ]; then
          # Run initial command: pytest -m stability tests/
          PYTEST_COMMAND="pytest -m stability tests/ ${{ inputs.pytest-args }}"
          echo "ðŸ“‹ Running all stability tests"
        else
          # Run with combined markers: pytest -m "stability and {scenario}" tests/
          PYTEST_COMMAND="pytest -m \"stability and ${{ inputs.scenario }}\" tests/ ${{ inputs.pytest-args }}"
          echo "ðŸ“‹ Running stability tests for scenario: ${{ inputs.scenario }}"
        fi
        
        echo "ðŸš€ Command: $PYTEST_COMMAND"
        
        # Configure Playwright to save videos and screenshots
        export PLAYWRIGHT_VIDEO_DIR=test-results/videos
        export PLAYWRIGHT_SCREENSHOT_DIR=test-results/screenshots
        
        # Run tests and capture output
        $PYTEST_COMMAND 2>&1 | tee test-results/logs/test-execution.log
        
        TEST_EXIT_CODE=$?
        
        # Move report.html to test-results directory if it exists
        if [ -f "report.html" ]; then
          mv report.html test-results/
          echo "ðŸ“Š Moved report.html to test-results/"
        fi
        
        # Generate summary
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "result=success" >> $GITHUB_OUTPUT
          echo "summary=âœ… All tests passed successfully" >> $GITHUB_OUTPUT
        else
          echo "result=failure" >> $GITHUB_OUTPUT
          echo "summary=âŒ Some tests failed (exit code: $TEST_EXIT_CODE)" >> $GITHUB_OUTPUT
        fi
        
        # Count test results
        TOTAL_TESTS=$(grep -o "collected [0-9]\+ item" test-results/logs/test-execution.log | grep -o "[0-9]\+" || echo "0")
        PASSED_TESTS=$(grep -o "[0-9]\+ passed" test-results/logs/test-execution.log | grep -o "[0-9]\+" || echo "0")
        FAILED_TESTS=$(grep -o "[0-9]\+ failed" test-results/logs/test-execution.log | grep -o "[0-9]\+" || echo "0")
        
        echo "total-tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passed-tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
        echo "failed-tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
        
        exit $TEST_EXIT_CODE

    - name: List generated files
      shell: bash
      if: always()
      run: |
        echo "ðŸ“‚ Generated test artifacts:"
        find test-results -type f -exec ls -la {} \;
